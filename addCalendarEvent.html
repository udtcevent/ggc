<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        ระบบบริหารจัดการปฏิทินงานและการแจ้งเตือนผ่านไลน์ - UDTC Announcement
    </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/48ae6a34dc.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/style.css" />
    <script type="text/javascript">
        $(document).ready(() => {
            if (localStorage.sess == null) {
                window.location.replace('main.html');
            }
        });
    </script>
</head>

<body>
    <div id="modal" style="width: 100%;"></div>
    <div id="loadTopBar" style="width: 100%">
        <table class="table table-striped" style="background-color: #212121; color: #fff">
            <thead>
                <tr>
                    <th style="width:20%; vertical-align:middle; font-weight: bold; font-size:16px;"><a href="#" style="text-decoration: none; color:#fff; font-size:20px;">MAIN PAGE - หน้าหลัก</a></th>
                    <th style="width: 20%"><button type="button" id="authorize_button" class="btn btn-warning btn-lg" style="width: 100%" onclick="handleAuthClick()"><i class="fa fa-google"></i></button></th>
                    <th style="width: 20%"><button type="button" id="btnShowCalendar" class="btn btn-success btn-lg" style="width: 100%"><i class="fa fa-calendar"></i> แสดงปฏิทินกิจกรรม</button></th>
                    <th style="width: 20%"><button type="button" id="btnSetting" class="btn btn-primary btn-lg" style="width: 100%"><i class="fa fa-cogs"></i> ตั้งค่าระบบ</button></th>
                    <th style="width: 20%"><button type="button" id="btnSignOut" class="btn btn-danger btn-lg" style="width: 100%"><i class="fa fa-sign-out"></i> ออกจากระบบ</button></th>
                </tr>
            </thead>
        </table>
    </div>

    <div class="row" style="padding:0 2% 1% 2%;">
        <h3 style="width:100%; background-color: #000; color: #fff; padding:10px;">แบบฟอร์มกรอกข้อมูลบันทึกปฏิทินกิจกรรม</h3>
        <input type="hidden" id="rowID" value="" /> <!-- rowID data -->
        <span class="input-group-text" style="width:10%; background-color:#000; color:#fff;">ประเภทกิจกรรม</span>
        <select class="form-select" id="eventTypeID" style="width:40%;" disabled></select>
        <span class="input-group-text" style="width:10%; background-color:#000; color:#fff;">หัวข้อกิจกรรม</span>
        <input type="text" id="eventTitle" style="width:40%;" class="form-control" placeholder="หัวข้อกิจกรรม (ถ้ามี)" aria-label="หัวข้อกิจกรรม">

        <span class="input-group-text" style="width:20%; background-color:#000; color:#fff;">สถานที่จัดกิจกรรม(ถ้ามี)</span>
        <input type="text" id="eventLocation" style="width:80%;" class="form-control" placeholder="สถานที่จัดกิจกรรม(ถ้ามี)" aria-label="สถานที่จัดกิจกรรม(ถ้ามี)">
        <span class="input-group-text" style="width:20%; background-color:#000; color:#fff;">รายละเอียดหรือชื่อผู้เกี่ยวข้อง(ถ้ามี)</span>
        <textarea type="text" id="eventDetails" style="width:80%;" class="form-control" style="height:80px;" placeholder="รายละเอียด หรือชื่อผู้เกี่ยวข้อง(ถ้ามี)" aria-label="รายละเอียด หรือชื่อผู้เกี่ยวข้อง(ถ้ามี)"></textarea>

        <span class="input-group-text" style="width:10%; background-color:#01579B; color:#fff;">วันที่เริ่มกิจกรรม</span>
        <select class="form-select" style="width:10%;" id="dayStartDate"></select>
        <select class="form-select" style="width:15%;" id="monthStartDate"></select>
        <select class="form-select" style="width:15%;" id="yearStartDate"></select>

        <span class="input-group-text" style="width:10%; background-color:#01579B; color:#fff;">วันสิ้นสุดกิจกรรม</span>
        <select class="form-select" style="width:10%;" id="dayEndDate"></select>
        <select class="form-select" style="width:15%;" id="monthEndDate"></select>
        <select class="form-select" style="width:15%;" id="yearEndDate"></select>

        <span class="input-group-text" style="width:10%; background-color:#01579B; color:#fff;">เวลาเริ่มต้น</span>
        <select class="form-select" style="width:20%;" id="hourStart"></select>
        <select class="form-select" style="width:20%;" id="minuitStart"></select>

        <span class="input-group-text" style="width:10%; background-color:#01579B; color:#fff;">เวลาสิ้นสุด</span>
        <select class="form-select" style="width:20%;" id="hourEnd"></select>
        <select class="form-select" style="width:20%;" id="minuitEnd"></select>
        <hr/>
        <button type="button" id="btnAddNewCalendarEvent" class="btn btn-success btn-lg"><i class="fa fa-upload"></i> บันทึกข้อมูลกิจกรรม</button>
    </div>

    <div id="allCalendarEvent" style="width: 100%;">
        <div class="row" style="padding:0 2% 1% 2%;">
            <h3 style="width:100%; background-color: #000; color: #fff; padding:10px;">รายการปฏิทินกิจกรรมต่างๆ</h3>
            <table class="table table-striped" style="background-color:#212121; color:#fff;">
                <thead>
                    <tr>
                        <th style="width:80%;">
                            <input type="text" id="searchBoxEvent" style="width:100%; height:58px;" class="form-control" placeholder="ค้นหาจาก Keyword" aria-label="ค้นหาจาก Keyword">
                        </th>
                        <th style="width:20%"><button type="button" id="btnSearchEvent" class="btn btn-primary btn-lg" style="width:100%; height:58px;"><i class="fa fa-search"></i> ค้นข้อมูล</button></th>
                    </tr>
                </thead>
            </table>

            <table class="table table-striped">
                <thead>
                    <tr style="background-color: #000; color:#fff; text-align:center;">
                        <th>#</th>
                        <th style="width:15%">หัวข้อกิจกรรม</th>
                        <th style="width:25%">รายละเอียด</th>
                        <th style="width:10%">วันเดือนปีกิจกรรม</th>
                        <th style="width:10%">เวลาเริ่มและสิ้นสุด</th>
                        <th>ผู้นำเข้าข้อมูล</th>
                        <th>วันที่นำเข้าข้อมูล</th>
                        <th style="width:15%">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="tBodyEvent"></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modalCentralUse" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-fullscreen" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div id="labelTitle" style="font-size:20px; font-weight: bold;"></div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btnTopClose"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="resetView" style="width:100%;">
                        <input type="hidden" id="rowID" style="width:100%;" class="form-control" placeholder="ID" aria-label="ID">
                        <div class="input-group mb-3">
                            <span class="input-group-text"style="background-color:#000; color:#fff; width:10%;">ประเภทกิจกรรม</span>
                            <select class="form-select" id="eventTypeIDEdit" style="width:20%;" disabled></select>
                            <span class="input-group-text" style="background-color:#000; color:#fff; width:10%;">หัวข้อกิจกรรม</span>
                            <input type="text" id="eventTitleEdit" style="width:40%;" class="form-control" placeholder="หัวข้อกิจกรรม (ถ้ามี)" aria-label="หัวข้อกิจกรรม">
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text"
                                style="background-color:#000; color:#fff;">สถานที่จัดกิจกรรม(ถ้ามี)</span>
                            <input type="text" id="eventLocationEdit" class="form-control"
                                placeholder="สถานที่จัดกิจกรรม(ถ้ามี)" aria-label="สถานที่จัดกิจกรรม(ถ้ามี)">
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text"
                                style="background-color:#000; color:#fff;">รายละเอียดหรือชื่อผู้เกี่ยวข้อง(ถ้ามี)</span>
                            <textarea type="text" id="eventDetailsEdit" class="form-control" style="height:80px;"
                                placeholder="รายละเอียด หรือชื่อผู้เกี่ยวข้อง(ถ้ามี)"
                                aria-label="รายละเอียด หรือชื่อผู้เกี่ยวข้อง(ถ้ามี)"></textarea>
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text" style="background-color:#01579B; color:#fff;">วันที่เริ่มกิจกรรม</span>
                            <select class="form-select" id="dayStartDateEdit"></select>
                            <select class="form-select" id="monthStartDateEdit"></select>
                            <select class="form-select" id="yearStartDateEdit"></select>

                            <span class="input-group-text" style="background-color:#01579B; color:#fff;">วันสิ้นสุดกิจกรรม</span>
                            <select class="form-select" id="dayEndDateEdit"></select>
                            <select class="form-select" id="monthEndDateEdit"></select>
                            <select class="form-select" id="yearEndDateEdit"></select>
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text" style="background-color:#01579B; color:#fff;">เวลาเริ่มต้น</span>
                            <select class="form-select" id="hourStartEdit"></select>
                            <select class="form-select" id="minuitStartEdit"></select>

                            <span class="input-group-text" style="background-color:#01579B; color:#fff;">เวลาสิ้นสุด</span>
                            <select class="form-select" id="hourEndEdit"></select>
                            <select class="form-select" id="minuitEndEdit"></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btnActionClose">ปิด</button>
                    <button type="button" class="btn btn-primary" id="btnActionEvent">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <pre id="content" style="white-space: pre-wrap;"></pre>
    <script src="js/index.js" type="text/javascript"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXuyGGsox3SfxIKNcV9l9TdgvJSmJ29Gc",
            authDomain: "e-announce-cbadd.firebaseapp.com",
            databaseURL: "https://e-announce-cbadd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-announce-cbadd",
            storageBucket: "e-announce-cbadd.appspot.com",
            messagingSenderId: "346672324711",
            appId: "1:346672324711:web:210d2061ab078b1e9f34c2",
            measurementId: "G-C6X5CD7P0P"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        import { getDatabase, ref, child, onValue, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        const db = getDatabase();

        let btnShowCalendar = document.getElementById('btnShowCalendar');
        let btnSetting = document.getElementById('btnSetting');

        const CheckViewSettingButton = () => {
            const dbRef = ref(db);
            const data = JSON.parse(localStorage.sess);

            let partUser = 'users/' + data.SECRET_ID;

            get(child(dbRef, partUser)).then((snapshot) => {
                if (snapshot.exists()) {
                    let snap = snapshot.val();
                    get(child(dbRef, partUser + '/authenticated')).then((authchk) => {
                        let auth = authchk.val();
                        if (authchk.exists()) {
                            if (auth.authLevel != 'ผู้ดูแลระบบ') {
                                btnShowCalendar.style.display = "none";
                                btnSetting.id = 'btnShowCalendar';
                                btnSetting.className = 'btn btn-success btn-lg';
                                btnSetting.innerHTML = '<i class="fa fa-calendar"></i>  แสดงปฏิทินกิจกรรม';
                                btnSetting.addEventListener('click', () => {
                                    ShowCalendarEvent();
                                });
                            } else {
                                btnShowCalendar.style.display = "block";
                                btnSetting.addEventListener('click', () => {
                                    SettingPage();
                                });
                            }
                        }
                    }).catch((error) => {
                        console.log(error);
                    });
                }
            }).catch((err) => {
                console.log(err);
            });
        }

        window.addEventListener('load', CheckViewSettingButton);

        let curDateMain = new Date();
        let curDate = curDateMain.getFullYear() + '-' + (curDateMain.getMonth() < 10 ? '0' + (curDateMain.getMonth() + 1) : (curDateMain.getMonth() + 1)) + '-' + (curDateMain.getDate() < 10 ? '0' + curDateMain.getDate() : curDateMain.getDate());
        let curTime = curDateMain.getHours() + ':' + curDateMain.getMinutes() + ':' + curDateMain.getSeconds() + ':' + '00';

        let resetView = document.getElementById('resetView');
        let eventTypeID = document.getElementById('eventTypeID');
        let eventTitle = document.getElementById('eventTitle');
        let eventDetails = document.getElementById('eventDetails');
        let eventLocation = document.getElementById('eventLocation');
        // let eventMoreType = document.getElementById('eventMoreType');

        let dayStartDate = document.getElementById('dayStartDate');
        let monthStartDate = document.getElementById('monthStartDate');
        let yearStartDate = document.getElementById('yearStartDate');
        let dayEndDate = document.getElementById('dayEndDate');
        let monthEndDate = document.getElementById('monthEndDate');
        let yearEndDate = document.getElementById('yearEndDate');

        let hourStart = document.getElementById('hourStart');
        let minuitStart = document.getElementById('minuitStart');
        let hourEnd = document.getElementById('hourEnd');
        let minuitEnd = document.getElementById('minuitEnd');

        let btnAddNewCalendarEvent = document.getElementById('btnAddNewCalendarEvent');

        // let modalHeader = document.getElementsByClassName('modal-header');
        let lebalTitle = document.getElementById('labelTitle');
        let btnTopClose = document.getElementById('btnTopClose');
        let btnActionEvent = document.getElementById('btnActionEvent');
        let btnActionClose = document.getElementById('btnActionClose');

        let eventTypeIDEdit = document.getElementById('eventTypeIDEdit');
        let eventTitleEdit = document.getElementById('eventTitleEdit');
        let eventDetailsEdit = document.getElementById('eventDetailsEdit');
        let eventLocationEdit = document.getElementById('eventLocationEdit');
        // let eventMoreTypeEdit = document.getElementById('eventMoreTypeEdit');

        let dayStartDateEdit = document.getElementById('dayStartDateEdit');
        let monthStartDateEdit = document.getElementById('monthStartDateEdit');
        let yearStartDateEdit = document.getElementById('yearStartDateEdit');
        let dayEndDateEdit = document.getElementById('dayEndDateEdit');
        let monthEndDateEdit = document.getElementById('monthEndDateEdit');
        let yearEndDateEdit = document.getElementById('yearEndDateEdit');

        let hourStartEdit = document.getElementById('hourStartEdit');
        let minuitStartEdit = document.getElementById('minuitStartEdit');
        let hourEndEdit = document.getElementById('hourEndEdit');
        let minuitEndEdit = document.getElementById('minuitEndEdit');

        // let btnSearchEvent = getElementById('btnSearchEvent');
        // let searchBoxEvent = getElementById('searchBoxEvent');

        function loadEventType() {
            const dbRef = ref(db);

            get(child(dbRef, 'eventType/')).then((et) => {
                if (et.exists()) {
                    let i = 1;
                    et.val().map((e) => {
                        let optEventType = document.createElement('option');
                        optEventType.value = e;
                        optEventType.innerText = i + ')' + e;
                        eventTypeID.append(optEventType);
                        i++;
                    });
                    eventTypeID.disabled = false //enable the select
                }
            });
        }

        function loadEventTypeEdit() {
            const dbRef = ref(db);

            get(child(dbRef, 'eventType/')).then((et) => {
                if (et.exists()) {
                    let i = 1;
                    et.val().map((e) => {
                        let optEventType = document.createElement('option');
                        optEventType.value = e;
                        optEventType.innerText = i + ')' + e;
                        eventTypeIDEdit.append(optEventType);
                        i++;
                    });
                    eventTypeID.disabled = false //enable the select
                }
            });
        }

        // Clear Data field
        function clearThis(target) {
            if (target.value != '') {
                target.value = "";
            }
        }

        // Hash data encoding
        function stringToHash(string) {
            var hash = 0;
            if (string.length == 0) return hash;

            for (var i = 0; i < string.length; i++) {
                var char = string.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }

            return hash;
        }

        function convMonth(month) {
            switch (month) {
                case 1: month = "มกราคม"; break;
                case 2: month = "กุมภาพันธ์"; break;
                case 3: month = "มีนาคม"; break;
                case 4: month = "เมษายน"; break;
                case 5: month = "พฤษภาคม"; break;
                case 6: month = "มิถุนายน"; break;
                case 7: month = "กรกฎาคม"; break;
                case 8: month = "สิงหาคม"; break;
                case 9: month = "กันยายน"; break;
                case 10: month = "ตุลาคม"; break;
                case 11: month = "พฤศจิกายน"; break;
                case 12: month = "ธันวาคม"; break;
                default: break;
            }

            return month;
        }

        function setDayStartDate() {
            let n = 31;
            for (let i = 1; i < n; i++) {
                let optStartDay = document.createElement('option');
                optStartDay.value = (i < 10 ? '0' + i : (i + 1));
                optStartDay.innerHTML = (i < 10 ? '0' + i : (i + 1));
                dayStartDate.append(optStartDay);
            }
        }

        function setDayStartDateEdit() {
            let n = 31;
            for (let i = 1; i < n; i++) {
                let optStartDay = document.createElement('option');
                optStartDay.value = (i < 10 ? '0' + i : (i + 1));
                optStartDay.innerHTML = (i < 10 ? '0' + i : (i + 1));
                dayStartDateEdit.append(optStartDay);
            }
        }

        function setMonthStartDate() {
            let n = 12;
            for (let i = 1; i <= n; i++) {
                let optStartMonth = document.createElement('option');
                optStartMonth.value = (i < 10 ? '0' + i : (i + 1));
                optStartMonth.innerHTML = convMonth(i);
                monthStartDate.append(optStartMonth);
            }
        }

        function setMonthStartDateEdit() {
            let n = 12;
            for (let i = 1; i <= n; i++) {
                let optStartMonth = document.createElement('option');
                optStartMonth.value = (i < 10 ? '0' + i : (i + 1));
                optStartMonth.innerHTML = convMonth(i);
                monthStartDateEdit.append(optStartMonth);
            }
        }

        function setYearStartDate() {
            let curYearStart = (curDateMain.getFullYear() + 543);
            for (let i = (curYearStart - 10); i < (curYearStart + 10); i++) {
                let optYearStartDate = document.createElement('option');
                optYearStartDate.value = i;
                optYearStartDate.innerHTML = i;
                yearStartDate.append(optYearStartDate);
            }
        }

        function setYearStartDateEdit() {
            let curYearStart = (curDateMain.getFullYear() + 543);
            for (let i = (curYearStart - 10); i < (curYearStart + 10); i++) {
                let optYearStartDate = document.createElement('option');
                optYearStartDate.value = i;
                optYearStartDate.innerHTML = i;
                yearStartDateEdit.append(optYearStartDate);
            }
        }

        function setDayEndDate() {
            let n = 31;
            for (let i = 1; i < n; i++) {
                let optEndDay = document.createElement('option');
                optEndDay.value = (i < 10 ? '0' + i : (i + 1));
                optEndDay.innerHTML = (i < 10 ? '0' + i : (i + 1));
                dayEndDate.append(optEndDay);
            }
        }

        function setDayEndDateEdit() {
            let n = 31;
            for (let i = 1; i < n; i++) {
                let optEndDay = document.createElement('option');
                optEndDay.value = (i < 10 ? '0' + i : (i + 1));
                optEndDay.innerHTML = (i < 10 ? '0' + i : (i + 1));
                dayEndDateEdit.append(optEndDay);
            }
        }

        function setMonthEndDate() {
            let n = 12;
            for (let i = 1; i <= n; i++) {
                let optEndMonth = document.createElement('option');
                optEndMonth.value = (i < 10 ? '0' + i : (i + 1));
                optEndMonth.innerHTML = convMonth(i);
                monthEndDate.append(optEndMonth);
            }
        }

        function setMonthEndDateEdit() {
            let n = 12;
            for (let i = 1; i <= n; i++) {
                let optEndMonth = document.createElement('option');
                optEndMonth.value = (i < 10 ? '0' + i : (i + 1));
                optEndMonth.innerHTML = convMonth(i);
                monthEndDateEdit.append(optEndMonth);
            }
        }

        function setYearEndDate() {
            let curYearEnd = (curDateMain.getFullYear() + 543);
            for (let i = (curYearEnd - 10); i < (curYearEnd + 10); i++) {
                let optYearEndDate = document.createElement('option');
                optYearEndDate.value = i;
                optYearEndDate.innerHTML = i;
                yearEndDate.append(optYearEndDate);
            }
        }

        function setYearEndDateEdit() {
            let curYearEnd = (curDateMain.getFullYear() + 543);
            for (let i = (curYearEnd - 10); i < (curYearEnd + 10); i++) {
                let optYearEndDate = document.createElement('option');
                optYearEndDate.value = i;
                optYearEndDate.innerHTML = i;
                yearEndDateEdit.append(optYearEndDate);
            }
        }

        function setHourStart() {
            let n = 23;
            let curHourStart = curDateMain.getHours();
            for (let i = 0; i < n; i++) {
                let optStartHour = document.createElement('option');
                optStartHour.value = (i < 10 ? '0' + i : (i + 1));
                optStartHour.innerHTML = (i < 10 ? '0' + i : (i + 1));
                hourStart.append(optStartHour);
            }
        }

        function setHourStartEdit() {
            let n = 23;
            let curHourStart = curDateMain.getHours();
            for (let i = 0; i < n; i++) {
                let optStartHour = document.createElement('option');
                optStartHour.value = (i < 10 ? '0' + i : (i + 1));
                optStartHour.innerHTML = (i < 10 ? '0' + i : (i + 1));
                hourStartEdit.append(optStartHour);
            }
        }

        function setMinuitStart() {
            let n = 59;
            let curMinuitStart = curDateMain.getMinutes();
            for (let i = 0; i < n; i++) {
                let optStartMinuit = document.createElement('option');
                optStartMinuit.value = (i < 10 ? '0' + i : (i + 1));
                optStartMinuit.innerHTML = (i < 10 ? '0' + i : (i + 1));
                minuitStart.append(optStartMinuit);
            }
        }

        function setMinuitStartEdit() {
            let n = 59;
            let curMinuitStart = curDateMain.getMinutes();
            for (let i = 0; i < n; i++) {
                let optStartMinuit = document.createElement('option');
                optStartMinuit.value = (i < 10 ? '0' + i : (i + 1));
                optStartMinuit.innerHTML = (i < 10 ? '0' + i : (i + 1));
                minuitStartEdit.append(optStartMinuit);
            }
        }

        function setHourEnd() {
            let n = 23;
            for (let i = 0; i < n; i++) {
                let optEndHour = document.createElement('option');
                optEndHour.value = (i < 10 ? '0' + i : (i + 1));
                optEndHour.innerHTML = (i < 10 ? '0' + i : (i + 1));
                hourEnd.append(optEndHour);
            }
        }

        function setHourEndEdit() {
            let n = 23;
            for (let i = 0; i < n; i++) {
                let optEndHour = document.createElement('option');
                optEndHour.value = (i < 10 ? '0' + i : (i + 1));
                optEndHour.innerHTML = (i < 10 ? '0' + i : (i + 1));
                hourEndEdit.append(optEndHour);
            }
        }

        function setMinuitEnd() {
            let n = 59;
            for (let i = 0; i < n; i++) {
                let optEndMinuit = document.createElement('option');
                optEndMinuit.value = (i < 10 ? '0' + i : (i + 1));
                optEndMinuit.innerHTML = (i < 10 ? '0' + i : (i + 1));
                minuitEnd.append(optEndMinuit);
            }
        }

        function setMinuitEndEdit() {
            let n = 59;
            for (let i = 0; i < n; i++) {
                let optEndMinuit = document.createElement('option');
                optEndMinuit.value = (i < 10 ? '0' + i : (i + 1));
                optEndMinuit.innerHTML = (i < 10 ? '0' + i : (i + 1));
                minuitEndEdit.append(optEndMinuit);
            }
        }

        window.addEventListener('load', loadEventType);
        window.addEventListener('load', setDayStartDate);
        window.addEventListener('load', setMonthStartDate);
        window.addEventListener('load', setYearStartDate);
        window.addEventListener('load', setDayEndDate);
        window.addEventListener('load', setMonthEndDate);
        window.addEventListener('load', setYearEndDate);
        window.addEventListener('load', setHourStart);
        window.addEventListener('load', setMinuitStart);
        window.addEventListener('load', setHourEnd);
        window.addEventListener('load', setMinuitEnd);

        window.addEventListener('load', loadEventTypeEdit);
        window.addEventListener('load', setDayStartDateEdit);
        window.addEventListener('load', setMonthStartDateEdit);
        window.addEventListener('load', setYearStartDateEdit);
        window.addEventListener('load', setDayEndDateEdit);
        window.addEventListener('load', setMonthEndDateEdit);
        window.addEventListener('load', setYearEndDateEdit);
        window.addEventListener('load', setHourStartEdit);
        window.addEventListener('load', setMinuitStartEdit);
        window.addEventListener('load', setHourEndEdit);
        window.addEventListener('load', setMinuitEndEdit);

        let pathCalendarEvent = 'calendarEvent/';

        // Method function event Add Calendar Event
        function AddCalendarEvent() {
            const dbRef = ref(db);
            const data = JSON.parse(localStorage.sess);
            const eventStartDate = (yearStartDate.value - 543) + "-" + monthStartDate.value + "-" + dayStartDate.value;
            const eventEndDate = (yearEndDate.value - 543) + "-" + monthEndDate.value + "-" + dayEndDate.value;
            const eventStartTime = hourStart.value + ":" + minuitStart.value + ":00";
            const eventEndTime = hourEnd.value + ":" + minuitEnd.value + ":00";
            get(child(dbRef, pathCalendarEvent)).then((snapshot) => {
                let eventTypeIDValue = eventTypeID.value;
                let ID = curDateMain.getFullYear() + (curDateMain.getMonth() < 10 ? '0' + (curDateMain.getMonth() + 1) : (curDateMain.getMonth() + 1)) + (curDateMain.getDate() < 10 ? '0' + curDateMain.getDate() : curDateMain.getDate()) + curDateMain.getHours() + curDateMain.getMinutes() + curDateMain.getSeconds() + curDateMain.getMilliseconds();
                btnAddNewCalendarEvent.disabled = !btnAddNewCalendarEvent.disabled;
                set(ref(db, pathCalendarEvent + ID), {
                    eventID : ID,
                    eventTypeID: eventTypeIDValue,
                    eventTitle: (eventTitle.value == "" ? eventTypeID.value : eventTitle.value),
                    eventDetails: eventDetails.value,
                    eventLocation: eventLocation.value,
                    // eventMoreType: eventMoreType.value,
                    eventUserAddEvent: data.SECRET_ID,
                    eventStartDate: eventStartDate,
                    eventEndDate: eventEndDate,
                    eventStartTime: eventStartTime,
                    eventEndTime: eventEndTime,
                    eventDateCreateEvent: curDate + ' ' + curTime
                }).then(() => {
                    clearThis(eventTitle);
                    clearThis(eventDetails);
                    clearThis(eventLocation);
                    // clearThis(eventMoreType);
                    btnAddNewCalendarEvent.disabled = false;
                    alert(`เพิ่มกิจกรรม [ ${(eventTitle.value == "" ? eventTypeID.value : eventTitle.value)} ] ในปฏิทินเรียบร้อยแล้ว`);
                    SetDataCalendarEvent();
                }).catch((err) => {
                    console.log(err);
                });
            }).catch((err) => {
                console.log(err)
            });
        }

        function SignOut() {
            const data = JSON.parse(localStorage.sess);
            const dbRef = ref(db);
            const pathUser = 'users/' + data.SECRET_ID;

            get(child(dbRef, pathUser + '/nameofUser')).then((uSer) => {
                if (uSer.exists()) {
                    const dataUser = uSer.val().FrontName + uSer.val().fName + ' ' + uSer.val().lName;
                    alert(`[ ${dataUser} ] ได้ออกจากระบบเรียบร้อยแล้ว`);
                    localStorage.clear();
                    window.location.replace('main.html');
                }
            }).catch((err) => {
                console.log(err);
            });
        }

        // Click event Add Calendar Event
        btnAddNewCalendarEvent.addEventListener('click', AddCalendarEvent);
        // Click event Signout
        document.getElementById('btnSignOut').addEventListener('click', SignOut);

        // Go to Setting Page
        const SettingPage = () => {
            window.location.replace('setting.html');
        }

        // Show Calendar Event
        const ShowCalendarEvent = () => {
            const data = JSON.parse(localStorage.sess);
            const dbRef = ref(db);
            const pathUser = 'users/' + data.SECRET_ID;

            get(child(dbRef, pathUser + '/authenticated')).then((uSer) => {
                if (uSer.exists()) {
                    const chkAuth = uSer.val().authLevel;
                    if (chkAuth == "ผู้ดูแลระบบ") {
                        window.open('https://calendar.google.com/calendar/', '_blank');
                    } else {
                        window.open('https://calendar.google.com/calendar/embed?height=800&wkst=1&ctz=Asia%2FBangkok&bgcolor=%23ffffff&title=%E0%B8%A3%E0%B8%B0%E0%B8%9A%E0%B8%9A%E0%B9%81%E0%B8%88%E0%B9%89%E0%B8%87%E0%B9%80%E0%B8%95%E0%B8%B7%E0%B8%AD%E0%B8%99%E0%B8%81%E0%B8%B4%E0%B8%88%E0%B8%81%E0%B8%A3%E0%B8%A3%E0%B8%A1%E0%B8%A8%E0%B8%B2%E0%B8%A5%E0%B8%88%E0%B8%B1%E0%B8%87%E0%B8%AB%E0%B8%A7%E0%B8%B1%E0%B8%94%E0%B8%AD%E0%B8%B8%E0%B8%94%E0%B8%A3%E0%B8%98%E0%B8%B2%E0%B8%99%E0%B8%B5&src=dWR0Y2V2ZW50QGdtYWlsLmNvbQ&color=%23039BE5', '_blank');
                    }
                }
            }).catch((err) => {
                console.log(err);
            });
        }

        btnShowCalendar.addEventListener('click', ShowCalendarEvent);

        // Retrive data event from firebase
        let tBodyEvent = document.getElementById('tBodyEvent');
        let calendarEvent = [];
        let sno = 0;
        let eventID = document.getElementById('rowID')

        function SetDataCalendarEvent() {
            const dbRef = ref(db);
            const data = JSON.parse(localStorage.sess);
            const pathCalendarEvent = 'calendarEvent/';
            
            get(child(dbRef, pathCalendarEvent)).then((snapshot) => {
                if (snapshot.exists()) {
                    var snapValues = snapshot.val();
                    calendarEvent = [];
                    snapshot.forEach((childSnapshot, key) => {
                        const valKey = childSnapshot.key;
                        if (data.SECRET_ID == childSnapshot.val().eventUserAddEvent) {
                            calendarEvent.push(childSnapshot.val());
                        } 
                    });
                    ViewAllCalendarEvent();
                }
            }).catch((err) => {
                console.log(err);
            });
        }

        function OpenFormEditEvent(editID) {
            const modalFormUpdateEvent = ``;
            document.getElementById('modalFormEditCalendarEvents').append(modalFormUpdateEvent);
            modalForm.modal('show');
        }

        function ViewCalendarEvent(eventID, eventTitle, eventDetails, eventStartDate, eventEndDate, eventStartTime, eventEndTime, eventUserAddEvent, eventDateCreateEvent) {
            const dbRef = ref(db);
            const data = JSON.parse(localStorage.sess);

            let trow = document.createElement('tr');
            let td1 = document.createElement('td');
            let td2 = document.createElement('td');
            let td3 = document.createElement('td');
            let td4 = document.createElement('td');
            let td5 = document.createElement('td');
            let td6 = document.createElement('td');
            let td7 = document.createElement('td');
            let td8 = document.createElement('td');

            td1.innerHTML = eventID;
            td1.setAttribute('align', 'center');
            td2.innerHTML = eventTitle;
            td3.innerHTML = eventDetails.toString();
            // td3.setAttribute('width', '30%');

            const dateStartEvent = eventStartDate.substring(8, 10) + ' ' + convMonth(Number(eventStartDate.substring(5, 7))) + ' ' + (Number(eventStartDate.substring(0, 4)) + 543) + ' ถึง ';
            const dateEndEvent = eventEndDate.substring(8, 10) + ' ' + convMonth(Number(eventEndDate.substring(5, 7))) + ' ' + (Number(eventEndDate.substring(0, 4)) + 543);
            td4.setAttribute('align', 'center');
            td4.innerHTML = (eventStartDate == eventEndDate ? dateEndEvent : dateStartEvent + dateEndEvent);

            const startTime = eventStartTime.substring(0, 5) + ' ถึง ';
            const endTime = eventEndTime.substring(0, 5);
            td5.setAttribute('align', 'center');
            td5.innerHTML = startTime + endTime;

            let partUser = 'users/' + eventUserAddEvent;

            get(child(dbRef, partUser)).then((snapshot) => {
                if (snapshot.exists()) {
                    let snap = snapshot.val();
                    get(child(dbRef, partUser + '/authenticated')).then((authchk) => {
                        let auth = authchk.val();
                        if (authchk.exists()) {
                            td6.innerHTML = snap.nameofUser.FrontName + snap.nameofUser.fName + ' ' + snap.nameofUser.lName;
                        }
                    }).catch((error) => {
                        console.log(error);
                    });
                }
            }).catch((err) => {
                console.log(err);
            });

            const dateCreateEvent = eventDateCreateEvent.substring(8, 10) + ' ' + convMonth(Number(eventDateCreateEvent.substring(5, 7))) + ' ' + (Number(eventDateCreateEvent.substring(0, 4)) + 543);
            // const timeCreateEvent = 'เวลา : ' + eventDateCreateEvent.substring(11, 16);
            td7.setAttribute('align', 'center');
            td7.innerHTML = dateCreateEvent;

            let EditButton = document.createElement('button');
            let DeleteButton = document.createElement('button');

            EditButton.id = 'edit-' + eventID;
            EditButton.className = 'btn btn-info btn-lg';
            EditButton.innerHTML = '<i class="fa fa-edit"></i>';
            EditButton.setAttribute('data-bs-toggle', 'modal');
            EditButton.setAttribute('data-bs-target', '#modalCentralUse');
            EditButton.addEventListener('click', LoadModal);
            EditButton.disabled = (data.SECRET_ID == eventUserAddEvent ? false : true);

            DeleteButton.id = 'delete-' + eventID;
            DeleteButton.className = 'btn btn-danger btn-lg';
            DeleteButton.style.marginLeft = '20px;'
            DeleteButton.innerHTML = '<i class="fa fa-trash"></i>';
            DeleteButton.setAttribute('data-bs-toggle', 'modal');
            DeleteButton.setAttribute('data-bs-target', '#modalCentralUse');
            DeleteButton.addEventListener('click', LoadModal);
            DeleteButton.disabled = (data.SECRET_ID == eventUserAddEvent ? false : true);

            td8.append(EditButton, DeleteButton);
            td8.setAttribute('align', 'center');
            trow.append(td1, td2, td3, td4, td5, td6, td7, td8);
            tBodyEvent.append(trow);
        }

        function ViewAllCalendarEvent() {
            const data = JSON.parse(localStorage.sess);
            sno = 0;
            tBodyEvent.innerHTML = "";
            calendarEvent.forEach((event, index) => {
                ViewCalendarEvent(event.eventID, event.eventTitle, event.eventDetails, event.eventStartDate, event.eventEndDate, event.eventStartTime, event.eventEndTime, event.eventUserAddEvent, event.eventDateCreateEvent);
            });
        }

        window.addEventListener('load', SetDataCalendarEvent);
        
        const LoadModal = () => {
            const dbRef = ref(db);
            var targetId = (event.target.id.length > 1) ? event.target.id : event.target.parentElement.id;
            let string = targetId.toString().split('-');
            let mod = string[0];
            let selectedIndex = string[1];
            btnTopClose.className = 'btn btn-primary btn-lg';
            btnActionClose.innerText = 'ปิดหน้าต่าง';
            btnActionClose.className = 'btn btn-primary btn-lg'

            get(child(dbRef, 'calendarEvent/' + selectedIndex)).then((snapshot) => {
                if (snapshot.exists()) {
                    if (mod == 'edit') {
                        labelTitle.innerText = 'ท่านต้องการแก้ไขข้อมูล [ รหัสกิจกรรม : ' + snapshot.val().eventID + ', หัวข้อกิจกรรม : ' + snapshot.val().eventTitle + ' ] หรือไม่ ?';
                        btnActionEvent.className = 'btn btn-success btn-lg';
                        btnActionEvent.innerText = 'ยืนยันปรับปรุงข้อมูล';
                        btnActionEvent.addEventListener('click', UpdateEvent);

                        rowID.value = '';
                        eventTitle.value = '';
                        eventDetails.value = '';
                        eventLocation.value = '';
                        $(`#eventTypeIDEdit option[value=${snapshot.val().eventTypeID}]`).prop('selected', true);

                        rowID.value = selectedIndex;
                        eventTitleEdit.value = snapshot.val().eventTitle;
                        eventDetailsEdit.value = snapshot.val().eventDetails;
                        eventLocationEdit.value = snapshot.val().eventLocation;

                        const YearStartDate = (Number(snapshot.val().eventStartDate.substring(0, 4)) + 543).toString();
                        const YearEndDate = (Number(snapshot.val().eventEndDate.substring(0, 4)) + 543).toString();

                        $(`#dayStartDateEdit option[value=${snapshot.val().eventStartDate.substring(8, 10)}]`).prop('selected', true);
                        $(`#monthStartDateEdit option[value=${snapshot.val().eventStartDate.substring(5, 7)}]`).prop('selected', true);
                        $(`#yearStartDateEdit option[value=${YearStartDate}]`).prop('selected', true);
                        $(`#dayEndDateEdit option[value=${snapshot.val().eventEndDate.substring(8, 10)}]`).prop('selected', true);
                        $(`#monthEndDateEdit option[value=${snapshot.val().eventEndDate.substring(5, 7)}]`).prop('selected', true);
                        $(`#yearEndDateEdit option[value=${YearEndDate}]`).prop('selected', true);

                        $(`#hourStartEdit option[value=${snapshot.val().eventStartTime.substring(0, 2)}]`).prop('selected', true);
                        $(`#minuitStartEdit option[value=${snapshot.val().eventStartTime.substring(3, 5)}]`).prop('selected', true);
                        $(`#hourEndEdit option[value=${snapshot.val().eventEndTime.substring(0, 2)}]`).prop('selected', true);
                        $(`#minuitEndEdit option[value=${snapshot.val().eventEndTime.substring(3, 5)}]`).prop('selected', true);

                        eventTypeIDEdit.disabled = false;
                        eventTitleEdit.disabled = false;
                        eventDetailsEdit.disabled = false;
                        eventLocationEdit.disabled = false;

                        dayStartDateEdit.disabled = false;
                        monthStartDateEdit.disabled = false;
                        dayEndDateEdit.disabled = false;
                        monthEndDateEdit.disabled = false;
                        yearEndDateEdit.disabled = false;

                        hourStartEdit.disabled = false;
                        minuitStartEdit.disabled = false;
                        hourEndEdit.disabled = false;
                        minuitEndEdit.disabled = false;
                    }
                    if (mod == 'delete') {
                        labelTitle.innerText = 'ท่านต้องการลบข้อมูล [ รหัสกิจกรรม : ' + snapshot.val().eventID + ', หัวข้อกิจกรรม : ' + snapshot.val().eventTitle + ' ] หรือไม่ ?';
                        resetView.innerHTML = '';
                        resetView.append('ท่านต้องการลบรายการกิจกรรมนี้ ใช่หรือไม่ ?');

                        btnActionEvent.className = 'btn btn-danger btn-lg';
                        btnActionEvent.innerText = 'ยืนยันลบข้อมูล';
                        btnActionEvent.addEventListener('click', DeleteEvent);

                        rowID.value = '';
                        // eventTitle.value = '';
                        // eventDetails.value = '';
                        // eventLocation.value = '';
                        // $(`#eventTypeIDEdit option[value=${snapshot.val().eventTypeID}]`).prop('selected', true);

                        rowID.value = selectedIndex;
                        // eventTitleEdit.value = snapshot.val().eventTitle;
                        // eventDetailsEdit.value = snapshot.val().eventDetails;
                        // eventLocationEdit.value = snapshot.val().eventLocation;

                        // const YearStartDate = (Number(snapshot.val().eventStartDate.substring(0, 4)) + 543).toString();
                        // const YearEndDate = (Number(snapshot.val().eventEndDate.substring(0, 4)) + 543).toString();

                        // $(`#dayStartDateEdit option[value=${snapshot.val().eventStartDate.substring(8, 10)}]`).prop('selected', true);
                        // $(`#monthStartDateEdit option[value=${snapshot.val().eventStartDate.substring(5, 7)}]`).prop('selected', true);
                        // $(`#yearStartDateEdit option[value=${YearStartDate}]`).prop('selected', true);
                        // $(`#dayEndDateEdit option[value=${snapshot.val().eventEndDate.substring(8, 10)}]`).prop('selected', true);
                        // $(`#monthEndDateEdit option[value=${snapshot.val().eventEndDate.substring(5, 7)}]`).prop('selected', true);
                        // $(`#yearEndDateEdit option[value=${YearEndDate}]`).prop('selected', true);

                        // $(`#hourStartEdit option[value=${snapshot.val().eventStartTime.substring(0, 2)}]`).prop('selected', true);
                        // $(`#minuitStartEdit option[value=${snapshot.val().eventStartTime.substring(3, 5)}]`).prop('selected', true);
                        // $(`#hourEndEdit option[value=${snapshot.val().eventEndTime.substring(0, 2)}]`).prop('selected', true);
                        // $(`#minuitEndEdit option[value=${snapshot.val().eventEndTime.substring(3, 5)}]`).prop('selected', true);

                        // eventTypeIDEdit.disabled = false;
                        // eventTitleEdit.disabled = false;
                        // eventDetailsEdit.disabled = false;
                        // eventLocationEdit.disabled = false;

                        // dayStartDateEdit.disabled = false;
                        // monthStartDateEdit.disabled = false;
                        // yearStartDateEdit.disabled = false;

                        // dayEndDateEdit.disabled = false;
                        // monthEndDateEdit.disabled = false;
                        // yearEndDateEdit.disabled = false;

                        // hourStartEdit.disabled = false;
                        // minuitStartEdit.disabled = false;
                        // hourEndEdit.disabled = false;
                        // minuitEndEdit.disabled = false;
                    }
                }
            }).catch((err) => {
                console.log(err);
            });
        }

        const UpdateEvent = () => {
            // btnActionEvent.disabled = true;
            let dataUpdate = {};
            let id = rowID.value;
            let today = curDateMain.getFullYear() + '-' + (curDateMain.getMonth() < 10 ? '0' + (curDateMain.getMonth() + 1) : (curDateMain.getMonth() + 1)) + '-' + (curDateMain.getDate() < 10 ? '0' + curDateMain.getDate() : curDateMain.getDate()) + ' ' + curDateMain.getHours() + ':' + curDateMain.getMinutes() + ':' + curDateMain.getSeconds() + curDateMain.getMilliseconds();
            let eventStartDateEdit = (yearStartDateEdit.value - 543).toString() + '-' + monthStartDateEdit.value + '-' + dayStartDateEdit.value.toString();
            let eventEndDateEdit = (yearEndDateEdit.value - 543).toString() + '-' + monthEndDateEdit.value + '-' + dayEndDateEdit.value.toString();
            let eventStartTimeEdit = hourStartEdit.value.toString() + ':' + minuitStartEdit.value.toString() + ':00';
            let eventEndTimeEdit = hourEndEdit.value.toString() + ':' + minuitEndEdit.value.toString() + ':00';

            dataUpdate['calendarEvent/' + id + '/eventTypeID'] = eventTypeIDEdit.value;
            dataUpdate['calendarEvent/' + id + '/eventTitle'] = eventTitleEdit.value;
            dataUpdate['calendarEvent/' + id + '/eventDetails'] = eventDetailsEdit.value;
            dataUpdate['calendarEvent/' + id + '/eventLocation'] = eventLocationEdit.value;
            dataUpdate['calendarEvent/' + id + '/eventStartDate'] = eventStartDateEdit;
            dataUpdate['calendarEvent/' + id + '/eventEndDate'] = eventEndDateEdit;
            dataUpdate['calendarEvent/' + id + '/eventStartTime'] = eventStartTimeEdit;
            dataUpdate['calendarEvent/' + id + '/eventEndTime'] = eventEndTimeEdit;

            update(ref(db), dataUpdate).then(() => { 
                btnTopClose.click(); 
                SetDataCalendarEvent();
            });
            
        }

        const DeleteEvent = () => {
            // btnActionEvent.disabled = true;
            let id = rowID.value;
            remove(ref(db, 'calendarEvent/' + id)).then(() => { 
                btnTopClose.click(); 
                SetDataCalendarEvent();
            });
        }

        btnActionEvent.addEventListener('click', LoadModal);

        btnTopClose.addEventListener('click', () => {
            eventTitle.value = '';
            eventDetails.value = '';
            eventLocation.value = '';
            $('#modalCentralUse').modal('hide');
        });

        btnActionClose.addEventListener('click', () => {
            eventTitle.value = '';
            eventDetails.value = '';
            eventLocation.value = '';
            $('#modalCentralUse').modal('hide');
        });
        
        
        // const SearchEvent = () => {
        //     const valSearch = searchBoxEvent.value;

        // }
    </script>
</body>

</html>
